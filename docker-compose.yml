# Docker Compose para Inspector API
# Autor: Daniel Bermúdez
# Versión: 1.0.0
# Descripción: Configuración de servicios para desarrollo y producción

version: '3.8'

services:
  # Servicio de la aplicación FastAPI
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://inspector_user:inspector_pass@db:5432/inspector_db
      - SECRET_KEY=tu_clave_secreta_aqui_cambiar_en_produccion
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      - LOG_LEVEL=INFO
      - CORS_ORIGINS=http://localhost:3000,http://localhost:8080
      - ENABLE_CACHE=true
      - CACHE_TTL=300
      - MAX_CONNECTIONS=10
      - CONNECTION_TIMEOUT=30
      - REQUEST_TIMEOUT=60
      - ENABLE_COMPRESSION=true
      - COMPRESSION_LEVEL=6
      - ENABLE_LOGGING=true
      - LOG_FILE=logs/app.log
      - MAX_LOG_SIZE=10MB
      - LOG_BACKUP_COUNT=5
      - ENABLE_METRICS=true
      - METRICS_PORT=9090
      - ENABLE_HEALTH_CHECK=true
      - HEALTH_CHECK_INTERVAL=30
      - ENABLE_RATE_LIMITING=false
      - RATE_LIMIT_REQUESTS=100
      - RATE_LIMIT_WINDOW=60
      - ENABLE_CORS=true
      - CORS_ALLOW_CREDENTIALS=true
      - CORS_ALLOW_METHODS=GET,POST,PUT,DELETE,OPTIONS
      - CORS_ALLOW_HEADERS=*
      - ENABLE_SWAGGER=true
      - API_TITLE=Inspector API
      - API_DESCRIPTION=API para gestión de inventario de dispositivos
      - API_VERSION=1.0.0
      - API_CONTACT_NAME=Daniel Bermúdez
      - API_CONTACT_EMAIL=daniel@inspector.com
      - API_LICENSE_NAME=MIT
      - API_LICENSE_URL=https://opensource.org/licenses/MIT
    depends_on:
      - db
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - inspector-network

  # Servicio de base de datos PostgreSQL
  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=inspector_db
      - POSTGRES_USER=inspector_user
      - POSTGRES_PASSWORD=inspector_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    restart: unless-stopped
    networks:
      - inspector-network

  # Servicio de Redis para caché (opcional)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - inspector-network

  # Servicio de Nginx como proxy reverso (opcional)
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - inspector-network

volumes:
  postgres_data:
  redis_data:

networks:
  inspector-network:
    driver: bridge 