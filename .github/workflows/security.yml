# GitHub Actions Security Analysis Workflow
# Autor: Daniel Berm√∫dez
# Versi√≥n: 1.0.0
# Descripci√≥n: An√°lisis de seguridad automatizado

name: Security Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # Lunes a las 2 AM
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job de An√°lisis de Dependencias
  dependency-scan:
    name: An√°lisis de Dependencias
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety bandit
        
    - name: Verificar vulnerabilidades con Safety
      run: |
        safety check --json --output safety-report.json || true
        
    - name: An√°lisis de seguridad con Bandit
      run: |
        bandit -r app/ -f json -o bandit-report.json || true
        
    - name: Subir reportes de seguridad
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json

  # Job de Detecci√≥n de Secretos
  secret-detection:
    name: Detecci√≥n de Secretos
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: Detectar secretos con TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        args: --only-verified --format json --output trufflehog-report.json
        
    - name: Subir reporte de secretos
      uses: actions/upload-artifact@v4
      with:
        name: secret-reports
        path: trufflehog-report.json

  # Job de An√°lisis de Docker
  docker-security:
    name: An√°lisis de Docker
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: An√°lisis de Dockerfile con Hadolint
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        format: sarif
        output-file: hadolint-report.sarif
        
    - name: Subir reporte de Docker
      uses: actions/upload-artifact@v4
      with:
        name: docker-reports
        path: hadolint-report.sarif

  # Job de Resumen de Seguridad
  security-summary:
    name: Resumen de Seguridad
    runs-on: ubuntu-latest
    needs: [dependency-scan, secret-detection, docker-security]
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: Descargar reportes
      uses: actions/download-artifact@v4
      with:
        name: security-reports
        
    - name: Generar resumen
      run: |
        echo "üîí Resumen de An√°lisis de Seguridad"
        echo "=================================="
        echo ""
        echo "‚úÖ An√°lisis de dependencias completado"
        echo "‚úÖ Detecci√≥n de secretos completada"
        echo "‚úÖ An√°lisis de Docker completado"
        echo ""
        echo "üìä Reportes disponibles en la pesta√±a Actions"
        echo "üîç Revisa los reportes para identificar vulnerabilidades"
        echo ""
        echo "üöÄ Recomendaciones:"
        echo "- Actualiza dependencias vulnerables"
        echo "- Revisa el c√≥digo en busca de secretos hardcodeados"
        echo "- Optimiza el Dockerfile para seguridad" 